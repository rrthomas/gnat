\ SMite assembler for pForth
\ Reuben Thomas   started 1/95

\ FIXME: Add an IP which allows advantage to be taken of packing opcodes
\ into the current word after an instruction with an operand is assembled

CR .( SMite assembler )


VOCABULARY ASSEMBLER  ALSO ASSEMBLER DEFINITIONS
: BITS   S" ADDRESS-UNIT-BITS" ENVIRONMENT?
   INVERT ABORT" ADDRESS-UNIT-BITS query not supported" ;
BITS  CONSTANT BITS/

FORTH DEFINITIONS
: CODE   BL WORD HEADER  ALSO ASSEMBLER ;
: END-CODE   ALIGN  PREVIOUS ;
ASSEMBLER DEFINITIONS

: INLINE   ( char -- )   LAST >INFO 2 + C! ;

: OPLESS   CREATE C,  DOES> C@ C, ;
: 0OPS   SWAP 1+ SWAP DO  I OPLESS  LOOP ;

\ FIXME: Use different prefix, not B!
$07 $00 0OPS  BHALT   BPOP    BDUP    BSWAP   BROTATE_UP BROTATE_DOWN BNOT BAND
$0F $08 0OPS  BOR     BXOR    BLSHIFT BRSHIFT BARSHIFT BEQ    BLT      BULT
$17 $10 0OPS  BNEGATE BADD    BMUL    BDIVMOD BUDIVMOD BLOAD   BSTORE  BLOADB
$1D $18 0OPS  BSTOREB BBRANCH BBRANCHZ BCALL  BGET_WORD_SIZE BGET_STACK_DEPTH
$1F $1E 0OPS  BSET_STACK_DEPTH BNOP
$3F $3E 0OPS  BLIB_C  BLIB_SMITE

6 CONSTANT LITERAL-CHUNK-BIT
1 LITERAL-CHUNK-BIT LSHIFT  1-  CONSTANT LITERAL-CHUNK-MASK
$40 CONSTANT LITERAL-CONTINUATION
2 CONSTANT NATIVE-POINTER-CELLS

PREVIOUS DEFINITIONS
